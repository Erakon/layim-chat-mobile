<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<script src="/layim-chat-mobile/plugins/jquery/jquery1.11.3.min.js"></script>
		<script src="/layim-chat-mobile/plugins/layIm/layui.js"></script>

		<title>历史记录</title>

		<style>
			body {
				margin: 0;
				box-sizing: border-box;
				width: 100%;
				height: 100%;
				position: absolute;
			}

			.layim-chat-main {
				width: 100% !important;
				height: 100% !important;
				box-sizing: border-box !important;
			}

			::-webkit-scrollbar {
				width: 10px;
				height: 10px;
			}

			::-webkit-scrollbar-thumb {
				border-radius: 5px;
				background-color: #ddd;
			}

			::-webkit-scrollbar-track {
				border-radius: 0;
				background: none;
			}
		</style>
	</head>

	<body>

		<div class="layim-chat-main">
			<ul id="LAY_view">

			</ul>
		</div>

		<!--<div id="LAY_page" style="margin: 0 10px;"></div>-->

		<!-- parent.layui.layim.cache().mine.id -->

		<textarea title="消息模版" id="LAY_tpl" style="display:none;">
		{{# layui.each(d.data, function(index, item){
		  if(item.mine){ }}

		    <li class="layim-chat-mine">
		    	<div class="layim-chat-user">
		    		<img src="{{ item.avatar.indexOf('http') == -1 ? (baseUrl + item.avatar) : item.avatar }}">
		    		<cite>
		    			<i>
		    				{{ layui.data.date(item.timestamp) }}
		    			</i>
		    			{{ item.username }}
		    		</cite>
		    	</div>
		    	<div class="layim-chat-text">
		    		{{ layui.layim.content(item.content) }}
		    	</div>
		    </li>

		  {{# } else { }}
		    <li>
		    	<div class="layim-chat-user">
		    		<img src="{{ item.avatar.indexOf('http') == -1 ? (baseUrl + item.avatar) : item.avatar }}">
		    		<cite>
		    			{{ item.username }}
		    			<i>
		    				{{ layui.data.date(item.timestamp) }}
		    			</i>
		    		</cite>
		    	</div>
		    	<div class="layim-chat-text">
		    		{{ layui.layim.content(item.content) }}
		    	</div>
		    </li>
		  {{# }
		}); }}
		</textarea>

		<script>
			layui.use(['layim', 'laypage'], function() {
				let layim = layui.layim,
					layer = layui.layer,
					laytpl = layui.laytpl,
					$ = layui.jquery,
					laypage = layui.laypage,
					param = location.search;
					baseUrl = "http://172.16.0.110";

				let pageNum = 1,
					pageSize = 10,
					total = 0,
					result = [];

				function search() {
					$.ajax({
						type: "get",
						url: baseUrl + "/im/user/chatRecord" + param,
						async: false,
						dataType: "json",
						data: {
							pageNum,
							pageSize
						},
						success: function(res) {
							console.log(res, '返回的聊天记录')
							total = res.total;

							res.data = res.data.reverse();

							res.data.forEach(item => {
								result.unshift(item);
							})
							console.log(result)
							let html = laytpl(LAY_tpl.value).render({
								data: result
							});
							$('#LAY_view').html(html);

							if (document.getElementById("LAY_view").offsetHeight < document.querySelector(".layim-chat-main").offsetHeight) {
								if (total > result.length) {
									pageNum++;
									search();
								}
							}
						}
					});
				}

				search();

				$(window).load(function () {
					setTimeout(() => {
						$(".layim-chat-main").scrollTop($(this).outerHeight(), 200);
					}, 50);

					setTimeout(() => {
						$(".layim-chat-main").on("scroll", function () {
							let scrollTop = $("#LAY_view").offset().top - 31;

							if (scrollTop < -20) {
								return;
							}

							if (total > result.length) {
								pageNum++;
								search();
							}
						})
					}, 300)
				})

				//分页按钮
				/*laypage.render({
					elem: 'LAY_page',
					curr: '${pager.pageNo}',
					count: '${pager.totalSize}' //数据总数
						,
					groups: 3 //连续显示分页数
						,
					skip: true,
					jump: function(obj, first) {
						//得到了当前页，用于向服务端请求对应数据
						var curr = obj.curr;
						if(!first) {
							var vl = param + "&skipToPage=" + curr;
							$.ajax({
								type: "get",
								url: baseUrl + "/im/user/chatRecord" + vl,
								async: false,
								dataType: "json",
								success: function(data) {
									result = data;
									console.log(data)
									var html = laytpl(LAY_tpl.value).render({
										data: result.data
									});
									$('#LAY_view').html(html);
								}
							});
						}
					}
				});*/
			});
		</script>

	</body>

</html>
